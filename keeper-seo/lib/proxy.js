'use strict';var _createClass=function(){function a(b,c){for(var e,d=0;d<c.length;d++)e=c[d],e.enumerable=e.enumerable||!1,e.configurable=!0,'value'in e&&(e.writable=!0),Object.defineProperty(b,e.key,e)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(c,d){function e(f,g){try{var h=b[f](g),j=h.value}catch(k){return void d(k)}return h.done?void c(j):Promise.resolve(j).then(function(k){e('next',k)},function(k){e('throw',k)})}return e('next')})}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var puppeteer=require('puppeteer'),path=require('path'),fs=require('fs'),Fastpost=require('./urldata'),fastpost=new Fastpost,Search=require('../work/search'),_search=new Search,Getip=require('./getip'),_getip=new Getip,Getcodeimg=require('./getcodeimg'),getcodeimg=new Getcodeimg,Getstate=require('./getstate'),_getstate=new Getstate,Delay=require('keeper-core/lib/delay'),delay=new Delay,Render=require('keeper-core/lib/render'),render=new Render,accbox=require('../config/account'),Mytime=require('keeper-core/lib/time'),mytime=new Mytime,Logger=require('keeper-core'),logger=new Logger,Logintest=require('../lib/auto-login'),_logintest=new Logintest,browser=[],selfbrowser={},ipdate=mytime.mydate('mins');logger.myconsole('Program start at : '.blue+ipdate),logger.myconsole('<p style="color: blue;">Program start at : '+ipdate+'</p>','web');var systemconfig=require('../config/system'),ipindex=0,browserindex=0,proxyindex=0,changeipactive=systemconfig.changeipactive,iplist=require('../config/iplist'),changeiptime=systemconfig.changeiptime,proxyserver=systemconfig.proxyserver,SlideLock=require('./slidelock'),slidelock=new SlideLock,InitJs=function(){function InitJs(){_classCallCheck(this,InitJs)}return _createClass(InitJs,[{key:'autoslide',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(d){var e;return regeneratorRuntime.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:return g.next=2,slidelock.autoslide(selfbrowser[browserindex],d);case 2:return e=g.sent,g.abrupt('return',e);case 4:case'end':return g.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'closeproxy',value:function closeproxy(){proxyserver=0,browser.close()}},{key:'openproxy',value:function openproxy(){proxyserver=1,this.initproxybrowser()}},{key:'setipinterval',value:function setipinterval(a){changeiptime=a,console.log('set ip interval : '+changeiptime+' mins')}},{key:'changebrowser',value:function changebrowser(){browserindex+=1,browserindex>=systemconfig.browsernumb&&(browserindex=0)}},{key:'changeproxy',value:function changeproxy(){proxyindex+=1,logger.myconsole('proxy : '.green+proxyindex),proxyindex>=systemconfig.proxyserver&&(proxyindex=0)}},{key:'init',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(){var d,e;return regeneratorRuntime.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:d=systemconfig.browsernumb,e=0;case 2:if(!(e<d)){g.next=9;break}return g.next=5,this.creatbrowser(e);case 5:selfbrowser[e]=g.sent;case 6:e++,g.next=2;break;case 9:case'end':return g.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'creatbrowser',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(d){var e=this;return regeneratorRuntime.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:return g.abrupt('return',new Promise(function(){var h=_asyncToGenerator(regeneratorRuntime.mark(function j(k){var l;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,puppeteer.launch({ignoreDefaultArgs:!0,args:['--no-sandbox','--disable-setuid-sandbox']});case 2:l=n.sent,logger.myconsole('self browser'+d+' is start!'.green),k(l);case 5:case'end':return n.stop();}},j,e)}));return function(){return h.apply(this,arguments)}}()));case 1:case'end':return g.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'initproxybrowser',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(){var d,e;return regeneratorRuntime.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:if(!proxyserver){g.next=12;break}d=0;case 2:if(!(d<proxyserver)){g.next=12;break}return e=iplist[d].address+':'+iplist[d].host,g.next=6,this.newbrowser(e);case 6:return browser[d]=g.sent,g.next=9,this.getip(browser[d]);case 9:d++,g.next=2;break;case 12:case'end':return g.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'newbrowser',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(d){var e=this;return regeneratorRuntime.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:return g.abrupt('return',new Promise(function(){var h=_asyncToGenerator(regeneratorRuntime.mark(function j(k){var l,m;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return l=['--no-sandbox','--disable-setuid-sandbox'],d&&l.push('--proxy-server='+d),o.next=4,puppeteer.launch({ignoreDefaultArgs:!0,args:l});case 4:return m=o.sent,logger.myconsole('browser is start!'.magenta),o.next=8,delay.delay(0);case 8:k(m);case 9:case'end':return o.stop();}},j,e)}));return function(){return h.apply(this,arguments)}}()));case 1:case'end':return g.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'changeip',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(){var d;return regeneratorRuntime.wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return ipindex+=1,ipindex>=iplist.length&&(ipindex=0),d=iplist[ipindex].address+':'+iplist[ipindex].host,f.next=5,this.restart(d);case 5:return f.next=7,this.getip();case 7:return f.next=9,getcodeimg.writeacc(!1,'curr');case 9:case'end':return f.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'restart',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(d){return regeneratorRuntime.wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return ipdate=mytime.mydate('mins'),logger.myconsole(ipdate),logger.myconsole('changeiptime : '.green+changeiptime),logger.myconsole('<p>'+ipdate+'</p>','web'),logger.myconsole('<p style="color: green">changeiptime : </p>'+changeiptime,'web'),f.next=7,this.newbrowser(d);case 7:case'end':return f.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'getproxystatus',value:function getproxystatus(){var a={ipindex:proxyserver?ipindex:-1,browserindex:browserindex,changeipactive:changeipactive,changeiptime:changeiptime};return a}},{key:'close',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(){var d,e;return regeneratorRuntime.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:g.t0=regeneratorRuntime.keys(selfbrowser);case 1:if((g.t1=g.t0()).done){g.next=7;break}return d=g.t1.value,g.next=5,selfbrowser[d].close();case 5:g.next=1;break;case 7:if(!browser.length){g.next=15;break}g.t2=regeneratorRuntime.keys(browser);case 9:if((g.t3=g.t2()).done){g.next=15;break}return e=g.t3.value,g.next=13,browser[e].close();case 13:g.next=9;break;case 15:case'end':return g.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'manualchangeip',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return changeipactive=!1,e.next=3,this.changeip();case 3:case'end':return e.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'autoproxy',value:function autoproxy(){changeipactive=!0,console.log('Active change ip is start!'.green)}},{key:'getproxylist',value:function getproxylist(){return iplist}},{key:'servermatrix',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(d,e,f,g){var h;return regeneratorRuntime.wrap(function(k){for(;;)switch(k.prev=k.next){case 0:if(h=systemconfig.cache,'changeip'!==g&&'Analysis failed!'!==g&&'Product is missing!'!==g){k.next=5;break}return k.next=4,fastpost.taobao(selfbrowser[browserindex],d,e,h,f,!0);case 4:g=k.sent;case 5:return k.abrupt('return',g);case 6:case'end':return k.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'taobao',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(d,e,f){var g,h,j;return regeneratorRuntime.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return proxyserver&&this.changeproxy(),g=systemconfig.cache,h=proxyserver?browser[proxyindex]:selfbrowser[browserindex],l.next=5,fastpost.taobao(h,d,e,g,f);case 5:return j=l.sent,proxyserver&&(j=this.servermatrix(d,e,f,j)),l.abrupt('return','changeip'===j?'Analysis failed!':j);case 8:case'end':return l.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'search',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(d,e,f){var g,h,j;return regeneratorRuntime.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return proxyserver&&this.changeproxy(),g=systemconfig.cache,h=proxyserver?browser[proxyindex]:selfbrowser[browserindex],l.next=5,_search.taobao(h,d,e,g,f);case 5:return j=l.sent,proxyserver&&(j=this.servermatrix(d,e,f,j)),l.abrupt('return','changeip'===j?'Analysis failed!':j);case 8:case'end':return l.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'getip',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(d){var e;return regeneratorRuntime.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:return g.next=2,_getip.getip(d);case 2:return e=g.sent,g.abrupt('return',e);case 4:case'end':return g.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'loginbycode',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(d,e){var f;return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(f=void 0,'self'!==d){h.next=7;break}return h.next=4,getcodeimg.getimg(selfbrowser[e||browserindex],d+(e||browserindex));case 4:f=h.sent,h.next=14;break;case 7:if(!('curr'===d&&proxyserver)){h.next=13;break}return h.next=10,getcodeimg.getimg(browser[e||proxyindex],d+(e||proxyinde));case 10:f=h.sent,h.next=14;break;case 13:f=!1;case 14:return h.abrupt('return',f);case 15:case'end':return h.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'getstate',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(d,e){var f;return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(f=!1,'self'!==d){h.next=7;break}return h.next=4,_getstate.getstate(selfbrowser[e||browserindex],d+(e||browserindex));case 4:f=h.sent,h.next=11;break;case 7:if(!('curr'===d&&proxyserver)){h.next=11;break}return h.next=10,_getstate.getstate(browser[e||proxyindex],d+(e||proxyinde));case 10:f=h.sent;case 11:return h.abrupt('return',f);case 12:case'end':return h.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()},{key:'login',value:function(){var _ref18=_asyncToGenerator(regeneratorRuntime.mark(function _callee18(loginurl,url,account){var page,file,tpl,param,mystr,Login,login,data;return regeneratorRuntime.wrap(function(_context18){for(;;)switch(_context18.prev=_context18.next){case 0:return _context18.next=2,selfbrowser[browserindex].newPage();case 2:return page=_context18.sent,file=path.join(__dirname,'/acc.js'),tpl=fs.readFileSync(file).toString(),param={acc:accbox[account].acc,psw:accbox[account].psw},mystr=render.renderdata(tpl,param),Login=eval(mystr),login=new Login,_context18.next=11,login.login(page,loginurl,url);case 11:return data=_context18.sent,_context18.abrupt('return',data);case 13:case'end':return _context18.stop();}},_callee18,this)}));return function login(){return _ref18.apply(this,arguments)}}()},{key:'logintest',value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function c(d,e){var f,g;return regeneratorRuntime.wrap(function(j){for(;;)switch(j.prev=j.next){case 0:return j.next=2,selfbrowser[browserindex].newPage();case 2:return f=j.sent,j.next=5,_logintest.login(f,d,e);case 5:return g=j.sent,j.abrupt('return',g);case 7:case'end':return j.stop();}},c,this)}));return function a(){return b.apply(this,arguments)}}()}]),InitJs}();module.exports=InitJs;
